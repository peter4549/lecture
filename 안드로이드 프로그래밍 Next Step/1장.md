# 안드로이드 프레임워크

## 1.1 안드로이드 아키텍처 개요
<img src="images/안드로이드 아키텍처.png" width="519" title="그림 1-1 안드로이드 아키텍처" alt="그림 1-1 안드로이드 아키텍처"></img>

### 1.1.1 애플리케이션
안드로이드에서 제공하는 선탑재 기본 앱(홈, 카메라, 전화, 브라우저 등)과 다운로드해서 설치하는 일반 앱은 애플리케이션 스택에 있다. 애플리케이션은 애플리케이션 프레임워크 스택 위에서 동작한다. 요점은 단말에 깔린 기본 앱과 우리가 만드는 앱은 동일한 레벨이라는 것이다.

다만 선탑재된 기본 앱은 시스템 권한을 사용할 수 있고, 프로세스 우선순위를 높일 수 있다는게 다르다. 프로세스 우선순위는 단말에 메모리가 부족한 상황에서 시스템에서 강제로 종료시키는 프로세스를 정하는 기준이다. 에를 들어 메모리가 아무리 부족해도 전화 앱이 중지되면 안 된다. 그래서 전화 앱은 우선순위가 높게 설정되어 있다.

### 1.1.2 애플리케이션 프레임워크
애플리케이션 프레임워크는 안드로이드 OS 위에서 애플리케이션의 기반이 되는 기본 구조다.

예를 들어보자. 앱에서 액티비티를 시작할 때 생성자로 '직접' 액티비티 인스턴스를 생성하고 생명주기 메서드를 호출하지는 않는다.(1). 또 환경 설정에서 언어가 변경될 때 앱에서 해당 언어의 리소스를 '직접' 찾아서 가져오지 않는다.(2) 이렇게 필요한 여러 동작을 '직접'하지 않아도 되는 것은 애플리케이션 프레임워크에서 알아서 하기 때문이다. 앱에서는 애플리케이션 프레임워크에서 정한 규칙에 따라서 만들기만 하면 된다. 나머지는 애플리케이션 프레임워크의 몫이다.

그림 1-1을 보면 애플리케이션 프레임워크에 여러 Manager가 있다는 것을 알 수 있다. 이들 Manager가 애플리케이션 프레임워크의 역할을 하고 있다. 예를 들면, Activity Manager는 액티비티를 생성해서 생명주기 메서드를 호출하는 역할을 하고(1) Resource Manager는 리소스를 찾아주는 역할을 한다(2).

#### 네이티브 C/C++ 코드 사용
여러 Manager는 대부분 자바로 작성되어 있다. 이 가운데서 하드웨어 제어나 빠른 속도가 필요한 것들은 내부적으로 JNI를 연결해서 네이티브 C/C++ 코드를 사용하기도 한다. Telephony Manager, Location Manager 등은 하드웨어를 제어하기 위해서, Resource Manager 등은 리소스 테이블을 유지하고 접근할 때 빠른 속도를 내기 위해 네이티브 C/C++을 사용한다.

#### 씬 클라이언트와 서버
Activity Manager는 클라이언트인 `ActivityManager`와 서버인 `ActivityManagerService`를 모두 포괄하는 개념이다. 각종 Manager도 마찬가지다. 서버 기능은 별도 프로세스인 `system_server`에서 실행된다. 앱 프로세스는 씬 클라이언트(thin client)이다. 앱 프로세스는 컴포넌트 탐색, 액티비티 스택 관리, 서비스 목록 유지, ANR 처리 등을 직접하지 않는다. 서버인 `system_server` 프로세스에 모두 위임하고 컴포넌트 실행 등 최소한의 역할만을 한다. `system_server`는 여러 앱을 통합해서 관리하는 '통합 문의 채널'이다.

예를 들어보자. `startActivity()`를 실행하면 먼저 `system_server`에서 해당 액티비티를 찾는다. 로컬 앱 프로세스에 있는 액티비티라도 역시 `system_server`에서 액티비티를 찾는다. 갤러리나 카메라 화면처럼 다른 앱의 액티비티를 띄우는 경우도 있는데, 해당 액티비티를 가진 앱 프로세스가 아직 떠있지 않다면 `system_server`에서 프로세스를 띄우기도 한다. `system_server`는 액티비티 스택에도 액티비티 내용을 반영하고, 마지막으로 액티비티를 가진 앱 프로세스에 액티비티를 띄우라고 메시지를 보낸다.

액티비티를 포함한 모든 안드로이드 컴포넌트는 `system_server`를 거쳐서 관리되고 `system_server`를 거쳐서 관리되고 `system_server`에서 앱 프로세스에 다시 메시지를 보내는 방식으로 동작한다.

#### 시스템 서비스 접근
여러 Manager 서버는 시스템 서비스 형태로 존재한다. 그리고 앱에서 접근할 때는 `Context`의 `getSystemService(String name)` 메서드를 사용한다. `system_server`라는 별도 프로세스에서 실행되므로 앱에서는 시스템 서비스에 접근할 때 Binder IPC를 이용한 프로세스간 통신이 필요하다.

> 안드로이드 컴포넌트에서 반드시 임포트해야 하는 android.* 패키지 클래스는 android jar 파일에 포함되어 있다. 바로 이 jar 파일이 애플리케이션 프레임워크 레벨에 있다. android.jar에는 android.* 패키지, com.android.* 패키지, 자바 기본 패키지(java.\*, javax.\*), Apache HttpClient(마시멜로에서 제거됨), DOM/SAX/XMLPullParser 등 자바 클래스와 안드로이드 기본 리소스(android.R)가 포함된다.

### 1.1.3 안드로이드 런타임
달빅 가상 머신은 자바/C/C++로 작성되어 있다(롤리팝부터 달빅을 대체한 ART 적용).<sup>1</sup> 레지스터 기반의 가상 머신으로 자바 가상 머신보다 명령이 단순하고 속도가 빠르다.

#### 코어 라이브러리
코어 라이브러리는 안드로이드 프레임 워크 소스에서 위치가 `/system/core`이다. 커널을 래핑하거나 추가 기능을 제공하는 역할을 한다.

> 1. https://source.android.com/devices/tech/dalvik/art.html<>을 참고하자
